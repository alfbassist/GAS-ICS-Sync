<!-- For Developers; anything marked //ParamUpdate needs to be updated when calendar parameters are added/removed... Find that string to make updating easier -->

<!DOCTYPE html>
<html>
<head>
    <title>GAS-ICS-Sync Calendar Manager</title>
    <?!= HtmlService.createHtmlOutputFromFile('styles').getContent(); ?>
</head>
<body onload="loadCalendarList(); loadAppSettings();">
<h1>GAS-ICS-Sync Calendar Manager</h1>
  <button onclick="install()">Install</button>
  <button onclick="uninstall()">Uninstall</button>

<h2>Master App Settings:</h2>
<form id="appSettingsForm">
  <table>
    <tr><td style="border: none;"><b>Required Inputs:</b></td></tr>
    <tr>
      <td><label for="howFrequent">Trigger Frequency: </label><span class="info" onclick="showDialog({type: 'alert', message: `What interval (minutes) to run this script to check for new/modified events.  Any integer can be used, but will be rounded up to 5, 10, 15, 30 or to the nearest hour after that.. 60, 120, etc. 1440 (24 hours) is the maximum value.  Anything above that will be replaced with 1440.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="number" style="width: 75px;" id="howFrequent" name="howFrequent" placeholder="# Minutes" required></td>
      <td style="border: none;">(Required)</td>
    </tr>
    <tr><td style="border: none;"><b>Optional Parameters:</b></td></tr>
    <tr>
      <td><label for="email">Email Address: </label><span class="info" onclick="showDialog({type: 'alert', message: `If Email Summary is checked or you want to receive update notifications, you will need to provide your email address.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="text" id="email" name="email" placeholder="xyz@gmail.com"></td>
    </tr>
    <tr>
      <td><label for="emailSummary">Email Summary: </label><span class="info" onclick="showDialog({type: 'alert', message: `Will email you when an event is added/modified/removed to/from your calendar.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="emailSummary" name="emailSummary"></td>

      <td><label for="customEmailSubject">Custom Email Subject: </label><span class="info" onclick="showDialog({type: 'alert', message: `If you want to change the email subject, provide a custom one here. Default: 'GAS-ICS-Sync Execution Summary'.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="text" id="customEmailSubject" name="customEmailSubject"></td>

      <td><label for="dateFormat">Date Format: </label><span class="info" onclick="showDialog({type: 'alert', message: `Custom date format in the email summary (e.g. 'YYYY-MM-DD', 'DD.MM.YYYY', 'MM/DD/YYYY'. Separators are '.', '-' and '/').`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="text" style="width: 100px;" id="dateFormat" name="dateFormat" placeholder="YYYY-MM-DD"></td>

    </tr>
  </table>
</form>
    <button onclick="saveAppSettings()">Save</button>

<br>
<hr>
<h2>Add/Edit Individual Calendar:</h2>
<form id="calendarForm">
  <table>
    <tr><td style="border: none;"><b>Required Inputs:</b></td></tr>
    <tr>
      <td><label for="sourceCalendarName">Source Calendar Name: </label><span class="info" onclick="showDialog({type: 'alert', message: `A short, friendly name for the source calendar.  This must also be a unique entry (can't be the same as any other calendars) as this is also used as the key in the json file.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="text" id="sourceCalendarName" name="sourceCalendarName" placeholder="Friendly Name" required></td>
      <td style="border: none;" colspan="100%">(Required. Must be a unique value not used for other calendars.)</td>
    </tr>
    <tr>
      <td><label for="sourceURL">Source Calendar URL: </label><span class="info" onclick="showDialog({type: 'alert', message: `The URL address of the .ics/,ical file you want to sync to Google.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="text" id="sourceURL" name="sourceURL" placeholder="URL of ics file" required></td>
      <td style="border: none;">(Required)</td>
    </tr>
    <tr>
      <td><label for="targetCalendarName">Target Calendar Name: </label><span class="info" onclick="showDialog({type: 'alert', message: `The name of the calendar in Google you want to sync to.  If the calendar doesn't yet exist, one will be created with this name.  If you want to sync to your main gmail calendar, use your xyz@gmail.com address as the Target Calendar Name.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="text" id="targetCalendarName" name="targetCalendarName" placeholder="Calendar name to Sync to" required></td>
      <td style="border: none;">(Required)</td>
    </tr>
    <tr><td style="border: none;"><b>Optional Parameters:</b></td></tr>
    <!--//ParamUpdate-->
    <tr>
      <td><label for="color">Color: <a href="https://developers.google.com/apps-script/reference/calendar/event-color" target="_blank">(Color Mapping)</a></label><span class="info" onclick="showDialog({type: 'alert', message: `The color you want to show for events in the Target Calendar.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="number" style="width: 50px;" id="color" name="color" placeholder="##"></td>
    </tr>
    <tr>
      <td><label for="sourceSyncDelay">Source Sync Delay (minutes): </label><span class="info" onclick="showDialog({type: 'alert', message: `Can be set to skip syncing on a given run if the Sync Delay hasn't &#8221;expired&#8221;. For example: if howFrequent is 15, but Sync Delay on a calendar is 60, then that calendar will only sync once every 4th iteration of the script (aka once per hour). Max is 1440 (one day).`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="number" style="width: 50px;" id="sourceSyncDelay" name="sourceSyncDelay" placeholder="##"></td>
    </tr>
    <tr>
      <td><label for="addEventsToCalendar">Add Events to Calendar: </label><span class="info" onclick="showDialog({type: 'alert', message: `If unchecked, you can check the log (View > Logs) to make sure your events are being read correctly before turning this on.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="addEventsToCalendar" name="addEventsToCalendar"></td>

      <td><label for="modifyExistingEvents">Modify Existing Events: </label><span class="info" onclick="showDialog({type: 'alert', message: `If unchecked, any event in the feed that was modified after being added to the calendar will not update`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="modifyExistingEvents" name="modifyExistingEvents"></td>
      
      <td><label for="removeEventsFromCalendar">Remove Events from Calendar: </label><span class="info" onclick="showDialog({type: 'alert', message: `If checked, any event created by the script that is not found in the feed will be removed.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="removeEventsFromCalendar" name="removeEventsFromCalendar"></td>
    </tr>
    <tr>
      <td width="300"><label for="onlyFutureEvents">Only Future Events: </label><span class="info" onclick="showDialog({type: 'alert', message: `Past events will not be synced. This will also remove past events from the target calendar if Remove Events From Calendar is checked.  However, past events can be kept by unchecking Remove Past Events From Calendar (below).`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="onlyFutureEvents" name="onlyFutureEvents"></td>

      <td width="300"><label for="getPastDaysIfOnlyFutureEvents">Past Days to Sync: </label><span class="info" onclick="showDialog({type: 'alert', message: `If Only Future Events (above) is checked, n number of days in the past can be retained by specifying # of days here.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="number" style="width: 50px;" id="getPastDaysIfOnlyFutureEvents" name="getPastDaysIfOnlyFutureEvents" placeholder="##"></td>

      <td width="300"><label for="removePastEventsFromCalendar">Remove Past Events from Calendar: </label><span class="info" onclick="showDialog({type: 'alert', message: `If unchecked, any event that is in the past will not be removed.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="removePastEventsFromCalendar" name="removePastEventsFromCalendar"></td>
    </tr>
    <tr>
      <td><label for="addOrganizerToTitle">Add Organizer to Title: </label><span class="info" onclick="showDialog({type: 'alert', message: `Prefix the event name with the event organiser for further clarity.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="addOrganizerToTitle" name="addOrganizerToTitle"></td>

      <td><label for="descriptionAsTitles">Description as Titles: </label><span class="info" onclick="showDialog({type: 'alert', message: `Use the ics/ical descriptions as titles (checked) or to use the normal titles as titles (unchecked).`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="descriptionAsTitles" name="descriptionAsTitles"></td>

      <td><label for="addCalToTitle">Add Calendar Name to Title: </label><span class="info" onclick="showDialog({type: 'alert', message: `Add the Friendly Calendar Name at the end of titles.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="addCalToTitle" name="addCalToTitle"></td>
    </tr>
    <tr>
      <td><label for="addAlerts">Add Alerts: </label><span class="info" onclick="showDialog({type: 'alert', message: `Whether to add the ics/ical alerts as notifications on the Google Calendar events or revert to the calendar's default reminders (yes, no, default).`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><select name="addAlerts" id="addAlerts">
        <option value="yes" selected="selected">yes</option>
        <option value="no">no</option>
        <option value="default">default</option>
      </select></td>
    </tr>
    <tr>
      <td><label for="addAttendees">Add Attendees: </label><span class="info" onclick="showDialog({type: 'alert', message: `Add the attendee list. If checked, duplicate events will be automatically added to the attendees' calendar.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="addAttendees" name="addAttendees"></td>
    </tr>
    <tr>
      <td><label for="defaultAllDayReminder">Default All Day Reminder: </label><span class="info" onclick="showDialog({type: 'alert', message: `Default reminder for all day events in minutes before the day of the event (-1 = no reminder, the value has to be between 0 and 40320).  See https://github.com/derekantrican/GAS-ICS-Sync/issues/75 for why this is neccessary.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="number" style="width: 60px;" id="defaultAllDayReminder" name="defaultAllDayReminder" placeholder="##"></td>
    </tr>
    <tr>
      <td><label for="overrideVisibility">Override Event Visibility: </label><span class="info" onclick="showDialog({type: 'alert', message: `Changes the visibility of the event (default, public, private, confidential). Anything else will revert to the class value of the ICAL event.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><select name="overrideVisibility" id="overrideVisibility">
        <option value="" selected="selected"></option>
        <option value="default">default</option>
        <option value="public">public</option>
        <option value="private">private</option>
        <option value="confidential">confidential</option>
      </select></td>
    </tr>
    <tr>
      <td><label for="addTasks">Add Tasks: </label><span class="info" onclick="showDialog({type: 'alert', message: `Choose whether to add Tasks.`})" style="color: blue; cursor: pointer;">&#x1F6C8</span></td>
      <td><input type="checkbox" id="addTasks" name="addTasks"></td>
    </tr>
  </table>
</form>
      <button onclick="addOrUpdateCalendar()">Save</button>
      <button onclick="cancelEdit()">Clear</button>
<hr>
<h2 id="calendarCountHeader">Current Calendars:</h2>
<div id="calendarContainer"></div>

<!--Dynamic dialog box-->
<div id="customDialog" style="display:none;">
    <p id="dialogMessage"><!-- Message will be added dynamically --></p>
    <div id="dialogButtons">
        <!-- Buttons will be added dynamically -->
    </div>
</div>

<!-- dims the background when a dialog box pops up -->
<div id="dialogBackground" style="display:none;"></div>

<!--Spinner while waiting for calendar list to laod-->
<div id="loadingSpinner" style="display: none;">
  <div class="spinner"></div>
</div>

<script>

/*************************************************** App Settings functions *****************************************************/

function install() {
  google.script.run
    .withSuccessHandler(function() {
      showDialog({type: 'alert', message: 'Install Successful.'});
    })
    .withFailureHandler(function(){
      showDialog({ type: 'alert', message: 'Install server error.'});
    })
  .install();
  refreshPage();
}

function uninstall() {
  google.script.run
  .withSuccessHandler(function() {
    showDialog({type: 'alert',message: 'Uninstall Successful.'});
  })
  .withFailureHandler(function(){
      showDialog({ type: 'alert', message: 'Uninstall server error.'});
    })
  .uninstall();
  refreshPage();
}

let appSettings = {}; // Object to store app settings

function loadAppSettings() {
  google.script.run
    .withSuccessHandler(function(receivedSettings) {
      if (receivedSettings) {
        // Apply the settings to the form
        document.getElementById("howFrequent").value = receivedSettings.howFrequent || '';
        document.getElementById("email").value = receivedSettings.email || '';
        document.getElementById("emailSummary").checked = receivedSettings.emailSummary || false;
        document.getElementById("customEmailSubject").value = receivedSettings.customEmailSubject || '';
        document.getElementById("dateFormat").value = receivedSettings.dateFormat || '';
      } else {
      // Handle the case where the App Settings do not exist
      console.log('appSettings json not found.  Try reloading the page.');
      return;
      }
    })
    .withFailureHandler(function(error){
      // Handle errors related to the execution of the server-side function
      console.error("Server error: " + error);
      showDialog({ type: 'alert', message: 'Server error: ' + error });
      refreshPage();
    })
    .getAppSettings();
}

function saveAppSettings() {
  // Create an object to hold the form data
  const appSettings = {
    howFrequent: +document.getElementById("howFrequent").value,
    email: document.getElementById("email").value,
    emailSummary: document.getElementById("emailSummary").checked,
    customEmailSubject: document.getElementById("customEmailSubject").value,
    dateFormat: document.getElementById("dateFormat").value,
  };

  // Validate input fields
  if (appSettings.howFrequent < 5 || appSettings.howFrequent > 1440) {
    showDialog({type: 'alert', message: 'Please input Trigger Frequency minutes between 5 and 1440 (one day).'});
    return false;
  }
  
  showLoadingSpinner();

  const jsonString = JSON.stringify(appSettings);
  google.script.run
    .withSuccessHandler(function(){
      console.log("Settings updated successfully.");
      showDialog({type: 'alert', message: 'Settings updated successfully.  If Trigger Frequency was changed, you will need to re-install.'});
      refreshPage();
    })
    .withFailureHandler(function(error){
      // Handle errors related to the execution of the server-side function
      console.error("Server error: " + error);
      showDialog({ type: 'alert', message: 'Server error: ' + error });
      refreshPage();
    })
    .updateAppSettings(jsonString);
}

/*************************************************** Calendar Management functions *****************************************************/

// functions for adding, editing, and deleting calendars
let calendarsFromJSON = {}; // Object to store calendar entries with sourceCalendarName as key

//Grabs existing entries from calendars.json
function loadCalendarList() {
  showLoadingSpinner();
  google.script.run
    .withSuccessHandler(function(data) {
      calendarsFromJSON = data; // Update the global variable with the fetched data
      displayCalendars(calendarsFromJSON);
      var calendarCount = Object.keys(calendarsFromJSON).length;
      document.getElementById("calendarCountHeader").textContent = `Current Calendars: ${calendarCount}`;
    })
    .getCalendars();
}

//Updates existing entries from calendars.json.  If no file exists, one will be created when first calendar entry is saved.
function addOrUpdateCalendar() {
  //grab raw values from numeric fields and accept either null (string) or numeric
  var rawValue_color = document.getElementById("color").value;
  var rawValue_sourceSyncDelay = document.getElementById("sourceSyncDelay").value;
  var rawValue_getPastDaysIfOnlyFutureEvents = document.getElementById("getPastDaysIfOnlyFutureEvents").value;
  var rawValue_defaultAllDayReminder = document.getElementById("defaultAllDayReminder").value;

    
  // Create an object to hold the form data
  const calendarEntry = {
    //ParamUpdate
    sourceCalendarName: document.getElementById("sourceCalendarName").value,
    sourceURL: document.getElementById("sourceURL").value,
    targetCalendarName: document.getElementById("targetCalendarName").value,
    color: rawValue_color === "" ? null : +rawValue_color,
    sourceSyncDelay: rawValue_sourceSyncDelay === "" ? null : +rawValue_sourceSyncDelay,
    addEventsToCalendar: document.getElementById("addEventsToCalendar").checked,
    modifyExistingEvents: document.getElementById("modifyExistingEvents").checked,
    removeEventsFromCalendar: document.getElementById("removeEventsFromCalendar").checked,
    onlyFutureEvents: document.getElementById("onlyFutureEvents").checked,
    getPastDaysIfOnlyFutureEvents: rawValue_getPastDaysIfOnlyFutureEvents === "" ? null : +rawValue_getPastDaysIfOnlyFutureEvents,
    removePastEventsFromCalendar: document.getElementById("removePastEventsFromCalendar").checked,
    addOrganizerToTitle: document.getElementById("addOrganizerToTitle").checked,
    descriptionAsTitles: document.getElementById("descriptionAsTitles").checked,
    addCalToTitle: document.getElementById("addCalToTitle").checked,
    addAlerts: document.getElementById("addAlerts").value,
    addAttendees: document.getElementById("addAttendees").checked,
    defaultAllDayReminder: rawValue_defaultAllDayReminder === "" ? null : +rawValue_defaultAllDayReminder,
    overrideVisibility: document.getElementById("overrideVisibility").value,
    addTasks: document.getElementById("addTasks").checked
  };

    // Validate input fields
  if (!calendarEntry.sourceURL || !calendarEntry.sourceCalendarName || !calendarEntry.targetCalendarName) {
      showDialog({type: 'alert',message: 'Please fill in all required fields.'});
      return false;
  }
  if (calendarEntry.color !== null && (isNaN(calendarEntry.color) || calendarEntry.color < 1 || calendarEntry.color > 11)) {
      showDialog({type: 'alert',message: 'Color must be between 1 and 11.'});
      return false;
  }
  if (calendarEntry.sourceSyncDelay !== null && (isNaN(calendarEntry.sourceSyncDelay) || calendarEntry.sourceSyncDelay < 15 || calendarEntry.sourceSyncDelay > 1440)) {
      showDialog({type: 'alert',message: 'Sync Delay must be between 15 and 1440.'});
      return false;
  }
  if (calendarEntry.defaultAllDayReminder !== null && (isNaN(calendarEntry.defaultAllDayReminder) || calendarEntry.defaultAllDayReminder < -1 || calendarEntry.defaultAllDayReminder > 40320)) {
      showDialog({type: 'alert',message: 'Default All Day Reminder must be between -1 and 40320.'});
      return false;
  }

  showLoadingSpinner();

  // Load existing calendars from the JSON file to know if this entry is new or existing
  if (calendarsFromJSON.hasOwnProperty(calendarEntry.sourceCalendarName)) {
    calendarsFromJSON[calendarEntry.sourceCalendarName] = calendarEntry;
    const jsonString = JSON.stringify(calendarsFromJSON);
    showDialog({
      type: 'confirm',
      message: `An entry for '${calendarEntry.sourceCalendarName}' already exists. Do you want to update it?`,
      onConfirm: function() {
        google.script.run
          .withSuccessHandler(function() {
            showDialog({type: 'alert',message: `Calendar '${calendarEntry.sourceCalendarName}' has been successfully updated.`});
            refreshPage();
          })
          .withFailureHandler(function(error) {
            // Handle any errors that occur during the execution
            console.error("Error updating calendar: ", error);
            showDialog({type: 'alert',message: `Something failed while updating '${calendarEntry.sourceCalendarName}'.`});
          })
          .updateCalendars(jsonString);
      },
      onCancel: function(){
      }
    });
  } else {
    calendarsFromJSON[calendarEntry.sourceCalendarName] = calendarEntry;
    const jsonString = JSON.stringify(calendarsFromJSON);
    google.script.run
      .withSuccessHandler(function() {
        showDialog({type: 'alert',message: `Calendar '${calendarEntry.sourceCalendarName}' has been successfully added.`});
        refreshPage();
      })
      .withFailureHandler(function(error) {
        console.error("Error updating calendar: ", error);
        showDialog({type: 'alert',message: `Something failed while adding '${calendarEntry.sourceCalendarName}'.`});
      })
      .updateCalendars(jsonString);
  }
}

//grabs calendar contents to populate html form
function editCalendar(sourceCalendarName) {
  if (calendarsFromJSON.hasOwnProperty(sourceCalendarName)) {
    const calendar = calendarsFromJSON[sourceCalendarName];
    //ParamUpdate
    document.getElementById("sourceCalendarName").value = calendar.sourceCalendarName;
    document.getElementById("sourceURL").value = calendar.sourceURL;
    document.getElementById("targetCalendarName").value = calendar.targetCalendarName;
    document.getElementById("color").value = calendar.color;
    document.getElementById("sourceSyncDelay").value = calendar.sourceSyncDelay;
    document.getElementById("addEventsToCalendar").checked = calendar.addEventsToCalendar;
    document.getElementById("modifyExistingEvents").checked = calendar.modifyExistingEvents;
    document.getElementById("removeEventsFromCalendar").checked = calendar.removeEventsFromCalendar;
    document.getElementById("onlyFutureEvents").checked = calendar.onlyFutureEvents;
    document.getElementById("getPastDaysIfOnlyFutureEvents").value = calendar.getPastDaysIfOnlyFutureEvents;
    document.getElementById("removePastEventsFromCalendar").checked = calendar.removePastEventsFromCalendar;
    document.getElementById("addOrganizerToTitle").checked = calendar.addOrganizerToTitle;
    document.getElementById("descriptionAsTitles").checked = calendar.descriptionAsTitles;
    document.getElementById("addCalToTitle").checked = calendar.addCalToTitle;
    document.getElementById("addAlerts").value = calendar.addAlerts;
    document.getElementById("addAttendees").checked = calendar.addAttendees;
    document.getElementById("defaultAllDayReminder").value = calendar.defaultAllDayReminder;
    document.getElementById("overrideVisibility").value = calendar.overrideVisibility;
    document.getElementById("addTasks").checked = calendar.addTasks;

  scrollToTop();
  } else {
    // Handle the case where the calendar entry does not exist although this should never happen
    console.error('Calendar entry not found for URL:', sourceCalendarName);
    showDialog({type: 'alert',message: 'Calendar entry not found.'});
  }
}

function cancelEdit() {
  document.getElementById("calendarForm").reset();
  resetFormToDefault();
}

//deletes selected calendar from calendars.json
function deleteCalendar(sourceCalendarName) {
  const calendar = calendarsFromJSON[sourceCalendarName];
  if (!calendar) {
    console.log("Calendar entry not found for URL:", sourceCalendarName);
    showDialog({type: 'alert',message: 'Calendar entry not found.'});
    return;
  }

  showDialog({
    type: 'confirm',
    message: `Are you sure you want to delete this calendar - ${calendar.sourceCalendarName}?`,
    onConfirm: function() {
      showLoadingSpinner();
      // Delete the calendar from the local JSON object
      delete calendarsFromJSON[sourceCalendarName];
      const jsonString = JSON.stringify(calendarsFromJSON);
      google.script.run
        .withSuccessHandler(function(){
          showDialog({type: 'alert',message: `${sourceCalendarName} deleted successfully.`,});
          refreshPage ();
        })
        .updateCalendars(jsonString);
      },
    onCancel: function() {
      console.log("Deletion cancelled.");
    }
  });
}



/*************************************************** General Page functions *****************************************************/

//shows a list of all existing calendars
function displayCalendars(calendars) {
    const calendarContainer = document.getElementById("calendarContainer");
    calendarContainer.innerHTML = ''; // Clear any existing content

    let tableContent = '<table>';
    // Loop over each sourceCalendarName to create tables
    for (const sourceCalendarName in calendars) {
        if (calendars.hasOwnProperty(sourceCalendarName)) {
            const calendar = calendars[sourceCalendarName];
            tableContent += `
      //<!--//ParamUpdate-->
      <tr><td><b>Source Calendar Name:</b></td><td><b>${calendar.sourceCalendarName}</b></td></tr>
      <tr><td width="200">Source URL:</td><td class="wrap" width="800">${calendar.sourceURL}</td></tr>
      <tr><td>Target Calendar Name:</td><td>${calendar.targetCalendarName}</td></tr>
      <tr><td>Color:</td><td>${calendar.color || ''}</td></tr>
      <tr><td>Sync Delay:</td><td>${calendar.sourceSyncDelay || ''}</td></tr>
      <tr><td>Add Events To Calendar:</td><td>${calendar.addEventsToCalendar || ''}</td></tr>
      <tr><td>Modify Existing Events:</td><td>${calendar.modifyExistingEvents || ''}</td></tr>
      <tr><td>Remove Events From Calendar:</td><td>${calendar.removeEventsFromCalendar || ''}</td></tr>
      <tr><td>Only Future Events:</td><td>${calendar.onlyFutureEvents || ''}</td></tr>
      <tr><td>Get Past Days If Only Future Events:</td><td>${calendar.getPastDaysIfOnlyFutureEvents || ''}</td></tr>
      <tr><td>Remove Past Events From Calendar:</td><td>${calendar.removePastEventsFromCalendar || ''}</td></tr>
      <tr><td>Add Organizer To Title:</td><td>${calendar.addOrganizerToTitle || ''}</td></tr>
      <tr><td>Description As Titles:</td><td>${calendar.descriptionAsTitles || ''}</td></tr>
      <tr><td>Add Calendar Name To Title:</td><td>${calendar.addCalToTitle || ''}</td></tr>
      <tr><td>Add Alerts:</td><td>${calendar.addAlerts || ''}</td></tr>
      <tr><td>Add Attendees:</td><td>${calendar.addAttendees || ''}</td></tr>
      <tr><td>Default All Day Reminder:</td><td>${calendar.defaultAllDayReminder || ''}</td></tr>
      <tr><td>Override Event Visibility:</td><td>${calendar.overrideVisibility || ''}</td></tr>
      <tr><td>Add Tasks:</td><td>${calendar.addTasks || ''}</td></tr>
      <tr>
        <td style="border: none;">
          <button onclick="editCalendar('${sourceCalendarName}')">Edit</button>
          <button onclick="deleteCalendar('${sourceCalendarName}')">Delete</button>
        </td>
      </tr>
      <tr><td style="border: none;" colspan="100%""><hr style="height: 3px; width:1000; align:left; background-color: #333;" ></td></tr>
    `;
        }
    }
    tableContent += '</table>';
    calendarContainer.innerHTML = tableContent; // Append the new list to the container
    resetFormToDefault();
}

function refreshPage() {
  // Clear input fields and reset the form
  document.getElementById("calendarForm").reset();
  // Reload the calendar list
  loadCalendarList();
  loadAppSettings();
  scrollToTop();
}

// Clear input fields and reset checkboxes to default.  Needed this as separate function so it could be called separately to clear the form only.
function resetFormToDefault() {
  //ParamUpdate
  document.getElementById("sourceCalendarName").value = "";
  document.getElementById("sourceURL").value = "";
  document.getElementById("targetCalendarName").value = "";
  document.getElementById("color").value = "";
  document.getElementById("sourceSyncDelay").value = "";
  document.getElementById("addEventsToCalendar").checked = true;
  document.getElementById("modifyExistingEvents").checked = true;
  document.getElementById("removeEventsFromCalendar").checked = true;
  document.getElementById("onlyFutureEvents").checked = false;
  document.getElementById("getPastDaysIfOnlyFutureEvents").value = "";
  document.getElementById("removePastEventsFromCalendar").checked = true;
  document.getElementById("addOrganizerToTitle").checked = false;
  document.getElementById("descriptionAsTitles").checked = false;
  document.getElementById("addCalToTitle").checked = false;
  document.getElementById("addAlerts").value = "";
  document.getElementById("addAttendees").checked = false;
  document.getElementById("defaultAllDayReminder").value = "";
  document.getElementById("overrideVisibility").value = "";
  document.getElementById("addTasks").checked = false;

  hideLoadingSpinner();
}

function showLoadingSpinner() {
  document.getElementById("loadingSpinner").style.display = "block";
}
function hideLoadingSpinner() {
  document.getElementById("loadingSpinner").style.display = "none";
}

//including custom dialogs because I don't like the default dialog.
function showDialog(options) {
  const {
    type,
    message,
    onConfirm,
    onCancel,
    edit
  } = options;

  document.getElementById('dialogMessage').innerText = message;
  const dialogButtons = document.getElementById('dialogButtons');
  dialogButtons.innerHTML = ''; // Clear previous buttons

  // Create Confirm button for 'confirm' type
  if (type === 'confirm') {
    const confirmBtn = document.createElement('button');
    confirmBtn.innerText = 'Confirm';
    confirmBtn.onclick = function () {
      closeDialog();
      if (onConfirm)
        onConfirm();
      };
    dialogButtons.appendChild(confirmBtn);

  // Create Cancel button for 'confirm' type
    const cancelBtn = document.createElement('button');
    cancelBtn.innerText = 'Cancel';
    cancelBtn.onclick = function () {
      closeDialog();
      if (onCancel)
        onCancel();
        hideLoadingSpinner();
      };
    dialogButtons.appendChild(cancelBtn);
  }

    // Create OK button for 'alert' type
  if (type === 'alert') {
    const okBtn = document.createElement('button');
    okBtn.innerText = 'OK';
    okBtn.onclick = closeDialog;
    dialogButtons.appendChild(okBtn);
  }

  if (type === 'edit') {
    document.getElementById('dialogMessage').innerHTML = message; // Use innerHTML for formContent

    // Create Save and Cancel buttons
    const saveBtn = document.createElement('button');
    saveBtn.innerText = 'Save';
    saveBtn.onclick = function () {
      if (onConfirm)
        onConfirm();
    };
    dialogButtons.appendChild(saveBtn);

    const cancelBtn = document.createElement('button');
    cancelBtn.innerText = 'Cancel';
    cancelBtn.onclick = closeDialog;
    dialogButtons.appendChild(cancelBtn);
  }

  document.getElementById('customDialog').style.display = 'block';
  document.getElementById('dialogBackground').style.display = 'block';
}

function closeDialog() {
  document.getElementById('customDialog').style.display = 'none';
  document.getElementById('dialogBackground').style.display = 'none';
}

function scrollToTop() {
  document.body.scrollTop = 0; // For Safari
  document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
}

</script>
</body>
</html>
